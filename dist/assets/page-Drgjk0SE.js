import{r,u as B,j as e,L as k}from"./index-mJd5pQzD.js";import{s as l,L as W}from"./Logo26Building-CFxxxnP5.js";function H(){const[g,C]=r.useState(null),[i,L]=r.useState(null),[h,D]=r.useState([]),[q,b]=r.useState(!0),[y,n]=r.useState(""),[d,E]=r.useState("all"),[R,x]=r.useState(!1),[o,m]=r.useState(null),[f,c]=r.useState(""),[p,N]=r.useState(!1),v=B();r.useEffect(()=>{P()},[]),r.useEffect(()=>{i&&g&&j()},[i,g,d]);const P=async()=>{try{const{data:{user:s}}=await l.auth.getUser();if(!s){v("/login");return}C(s);const{data:a,error:t}=await l.from("profiles").select("*").eq("id",s.id).single();if(t)throw t;if(L(a),!a?.is_admin){n("관리자 권한이 필요합니다.");return}}catch(s){console.error("사용자 확인 오류:",s),n("사용자 정보를 확인하는데 실패했습니다.")}finally{b(!1)}},j=async()=>{try{if(b(!0),n(""),console.log("관리자 민원 로딩 시작:",{profile:i,isAdmin:i?.is_admin}),!i?.is_admin){console.log("관리자 권한 없음"),n("관리자 권한이 필요합니다.");return}console.log("Supabase 쿼리 시작");let s=l.from("complaints").select("*").order("created_at",{ascending:!1});d!=="all"&&(s=s.eq("status",d));const{data:a,error:t}=await s;if(console.log("Supabase 쿼리 결과:",{data:a,error:t}),t)throw console.error("Supabase 오류:",t),t;const S=await Promise.all((a||[]).map(async u=>{const{data:U}=await l.from("profiles").select("name, email").eq("id",u.user_id).single(),{data:A}=u.admin_id?await l.from("profiles").select("name, email").eq("id",u.admin_id).single():{data:null};return{...u,profiles:U,admin_profiles:A}}));console.log("민원 데이터 설정:",S),D(S)}catch(s){console.error("민원 목록 로딩 오류:",s),n(`민원 목록을 불러오는데 실패했습니다: ${s instanceof Error?s.message:"알 수 없는 오류"}`)}finally{b(!1)}},F=s=>{m(s),c(s.admin_response||""),x(!0)},I=async()=>{if(o)try{N(!0),n("");const{error:s}=await l.from("complaints").update({admin_response:f.trim(),admin_id:g.id,response_date:new Date().toISOString(),status:f.trim()?"resolved":"in_progress",updated_at:new Date().toISOString()}).eq("id",o.id);if(s)throw s;await j(),x(!1),m(null),c("")}catch(s){console.error("답변 제출 오류:",s),n("답변 제출에 실패했습니다.")}finally{N(!1)}},w=async(s,a)=>{try{const{error:t}=await l.from("complaints").update({status:a,updated_at:new Date().toISOString()}).eq("id",s.id);if(t)throw t;await j()}catch(t){console.error("상태 변경 오류:",t),n("상태 변경에 실패했습니다.")}},M=s=>{switch(s){case"pending":return"접수됨";case"in_progress":return"처리중";case"resolved":return"해결됨";case"closed":return"종료됨";default:return s}},T=s=>{switch(s){case"pending":return"bg-yellow-100 text-yellow-800";case"in_progress":return"bg-blue-100 text-blue-800";case"resolved":return"bg-green-100 text-green-800";case"closed":return"bg-gray-100 text-gray-800";default:return"bg-gray-100 text-gray-800"}},$=s=>{switch(s){case"low":return"text-green-600";case"normal":return"text-blue-600";case"high":return"text-orange-600";case"urgent":return"text-red-600";default:return"text-gray-600"}},z=s=>({facility:"시설 관련",security:"보안 관련",noise:"소음 관련",parking:"주차 관련",elevator:"엘리베이터",cleaning:"청소 관련",management:"관리사무소",other:"기타"})[s]||s,_=s=>new Date(s).toLocaleDateString("ko-KR",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}),O=async()=>{await l.auth.signOut(),v("/")};return q?e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100",children:e.jsx("div",{className:"flex items-center justify-center min-h-screen",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600",children:"로딩 중..."})]})})}):y?e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100",children:e.jsx("div",{className:"flex items-center justify-center min-h-screen",children:e.jsxs("div",{className:"text-center",children:[e.jsx("i",{className:"ri-error-warning-line text-6xl text-red-500 mb-4"}),e.jsx("h1",{className:"text-2xl font-bold text-gray-900 mb-2",children:"오류가 발생했습니다"}),e.jsx("p",{className:"text-gray-600 mb-6",children:y}),e.jsx("button",{onClick:()=>window.location.reload(),className:"bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition-colors duration-200",children:"새로고침"})]})})}):e.jsxs("div",{className:"min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100",children:[e.jsx("header",{className:"bg-white shadow-sm",children:e.jsx("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8",children:e.jsxs("div",{className:"flex justify-between items-center py-6",children:[e.jsx(k,{to:"/",className:"flex items-center space-x-3",children:e.jsx(W,{size:40})}),e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx(k,{to:"/admin",className:"text-gray-600 hover:text-gray-900 font-medium",children:"관리자 대시보드"}),e.jsx("span",{className:"text-gray-400",children:"|"}),e.jsx("span",{className:"text-gray-600",children:i?.name||"관리자"}),e.jsx("button",{onClick:O,className:"text-red-600 hover:text-red-700 font-medium",children:"로그아웃"})]})]})})}),e.jsx("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-lg p-8",children:[e.jsxs("div",{className:"flex items-center justify-between mb-8",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900",children:"민원 관리"}),e.jsx("p",{className:"text-gray-600 mt-2",children:"접수된 민원을 확인하고 답변하세요."})]}),e.jsxs("div",{className:"text-sm text-gray-500",children:["총 ",h.length,"개의 민원"]})]}),e.jsx("div",{className:"mb-6",children:e.jsx("div",{className:"flex space-x-2",children:[{value:"all",label:"전체"},{value:"pending",label:"접수됨"},{value:"in_progress",label:"처리중"},{value:"resolved",label:"해결됨"},{value:"closed",label:"종료됨"}].map(s=>e.jsx("button",{onClick:()=>E(s.value),className:`px-4 py-2 rounded-lg text-sm font-medium transition-colors duration-200 ${d===s.value?"bg-blue-600 text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:s.label},s.value))})}),e.jsx("div",{className:"space-y-4",children:h.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx("i",{className:"ri-customer-service-line text-6xl text-gray-400 mb-4"}),e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-2",children:"민원이 없습니다"}),e.jsx("p",{className:"text-gray-600",children:"새로운 민원이 접수되면 여기에 표시됩니다."})]}):h.map(s=>e.jsx("div",{className:"border border-gray-200 rounded-xl p-6 hover:shadow-md transition-shadow duration-200",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-3",children:[e.jsx("span",{className:`inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${T(s.status)}`,children:M(s.status)}),e.jsx("span",{className:`text-sm font-medium ${$(s.priority)}`,children:s.priority==="low"?"낮음":s.priority==="normal"?"보통":s.priority==="high"?"높음":"긴급"}),e.jsx("span",{className:"text-sm text-gray-500",children:z(s.category)}),s.is_anonymous?e.jsxs("span",{className:"inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800",children:[e.jsx("i",{className:"ri-eye-off-line mr-1"}),"익명"]}):e.jsx("span",{className:"text-sm text-gray-500",children:s.profiles?.name})]}),e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-2",children:s.title}),e.jsx("p",{className:"text-gray-600 text-sm line-clamp-3 mb-3",children:s.content}),s.admin_response&&e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-3 mb-3",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("i",{className:"ri-customer-service-2-line text-blue-600"}),e.jsx("span",{className:"text-sm font-medium text-blue-900",children:"관리자 답변"}),s.admin_profiles&&e.jsxs("span",{className:"text-xs text-blue-700",children:["by ",s.admin_profiles.name]})]}),e.jsx("p",{className:"text-sm text-blue-800 line-clamp-2",children:s.admin_response})]}),e.jsxs("div",{className:"flex items-center gap-4 text-sm text-gray-500",children:[e.jsxs("span",{children:["접수: ",_(s.created_at)]}),s.response_date&&e.jsxs("span",{children:["답변: ",_(s.response_date)]})]})]}),e.jsxs("div",{className:"flex items-center gap-2 ml-6",children:[e.jsx("button",{onClick:()=>F(s),className:"p-2 text-blue-600 hover:bg-blue-100 rounded-lg transition-colors duration-200",title:"답변하기",children:e.jsx("i",{className:"ri-message-3-line"})}),s.status==="pending"&&e.jsx("button",{onClick:()=>w(s,"in_progress"),className:"p-2 text-orange-600 hover:bg-orange-100 rounded-lg transition-colors duration-200",title:"처리중으로 변경",children:e.jsx("i",{className:"ri-play-circle-line"})}),s.status==="resolved"&&e.jsx("button",{onClick:()=>w(s,"closed"),className:"p-2 text-gray-600 hover:bg-gray-100 rounded-lg transition-colors duration-200",title:"종료하기",children:e.jsx("i",{className:"ri-checkbox-circle-line"})})]})]})},s.id))})]})}),R&&o&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-2xl w-full max-w-2xl transform transition-all duration-300 scale-100",children:[e.jsx("div",{className:"bg-blue-500 text-white p-6 rounded-t-2xl",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold",children:"민원 답변"}),e.jsx("p",{className:"text-blue-100 text-sm mt-1",children:o.title})]}),e.jsx("button",{onClick:()=>{x(!1),m(null),c("")},className:"text-white hover:text-gray-200 transition-colors",children:e.jsx("svg",{className:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]})}),e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-2",children:"민원 내용"}),e.jsx("div",{className:"bg-gray-50 rounded-lg p-4",children:e.jsx("p",{className:"text-gray-700 whitespace-pre-wrap",children:o.content})})]}),e.jsxs("div",{className:"mb-6",children:[e.jsx("label",{htmlFor:"response",className:"block text-sm font-medium text-gray-700 mb-2",children:"관리자 답변"}),e.jsx("textarea",{id:"response",value:f,onChange:s=>c(s.target.value),className:"w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors duration-200 resize-none",placeholder:"민원에 대한 답변을 입력하세요",rows:6,disabled:p})]}),e.jsxs("div",{className:"flex space-x-3",children:[e.jsx("button",{onClick:()=>{x(!1),m(null),c("")},className:"flex-1 px-4 py-3 text-gray-600 bg-gray-100 hover:bg-gray-200 rounded-xl font-medium transition-colors duration-200",children:"취소"}),e.jsx("button",{onClick:I,disabled:p,className:"flex-1 px-4 py-3 bg-blue-600 text-white rounded-xl font-medium hover:bg-blue-700 transition-all duration-200 transform hover:scale-105 disabled:opacity-50 disabled:transform-none flex items-center justify-center gap-2",children:p?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}),"답변 중..."]}):e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"ri-send-plane-line"}),"답변 제출"]})})]})]})]})})]})}export{H as default};
